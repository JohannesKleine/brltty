#!/bin/bash
. /brltty/current/libexec/canute-prologue.sh

showProgramUsagePurpose() {
cat <<END_OF_PROGRAM_USAGE_PURPOSE
Start an X session with a terminal that has the same dimensions as the Canute's braille display.
END_OF_PROGRAM_USAGE_PURPOSE
}

defaultLogFile="/tmp/${programName}.log"
defaultSessionScript="${installTree}/libexec/canute-xsession"

addTestModeOption
addProgramOption l string.file logFile "the log file" "${defaultLogFile}"
addProgramOption s string.file sessionScript "the X session script" "${defaultSessionScript}"
addProgramOption n flag noMonitor "no monitor - use a virtual X display"
addProgramOption c flag clearScreen "clear screen on exit"
parseProgramArguments "${@}"

[ -n "${logFile}" ] || logFile="${defaultLogFile}"
verifyOutputFile "${logFile}"

[ -n "${sessionScript}" ] || sessionScript="${defaultSessionScript}"
verifyExecutableFile "${sessionScript}"
startxCommand=(startx "${sessionScript}")

"${noMonitor}" && {
   verifyHostCommand xorgPath Xorg
   startxCommand+=(-- "${xorgPath}")
   startxCommand+=(-config "${installTree}/etc/xorg-dummy-1920x1080.conf")
   [ -n "${XDG_VTNR}" ] && export WINDOWPATH="${XDG_VTNR}"
}

exec {standardOutput}>&1
"${testMode}" || exec &> "${logFile}"

executeHostCommand "${startxCommand[@]}"
exitStatus="${?}"

"${clearScreen}" && {
   exec >&${standardOutput}
   executeHostCommand clear
}

exit "${exitStatus}"
