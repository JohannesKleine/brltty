#!/bin/bash
. /brltty/current/libexec/canute-prologue.sh
shopt -s nullglob

showProgramUsagePurpose() {
cat <<END_OF_PROGRAM_USAGE_PURPOSE
Manage which table is used to render text on the Canute's braille display.
END_OF_PROGRAM_USAGE_PURPOSE
}

showProgramUsageNotes() {
cat <<END_OF_PROGRAM_USAGE_NOTES
The table-name parameter specifies the new table to be used for rendering braille.
If it isn't specified then the name and type of the current table are shown.
It may be specified with or without its file extension,
and may refer to a text (computer braillei), contraction (literary braille), or LibLouis table.
This can be constrained via the -c, -l, and -L options.
If none of these options are specified then -c and -l are assumed;
-L isn't because several BRLTTY and LibLouis tables have the same names.
END_OF_PROGRAM_USAGE_NOTES
}

testTable() {
   local name="${1}"
   local directory="${2}"
   local extension="${3}"

   local file="${name}"
   [ "${file}" != "${file%.*}" ] || file+=".${extension}"

   [ -f "${directory}/${file}" ] || return 1
   return 0
}

addProgramOption c flag allowTextTable "interpret the name as that of a computer braille table"
addProgramOption l flag allowContractionTable "interpret the name as that of a literary braille table"
addProgramOption L flag allowLiblouisTable "interpret the name as that of a LibLouis table"
optionalProgramParameters
addProgramParameter "table-name" tableName "the braille table to switch to"
parseProgramArguments "${@}"
set -e

if [ -n "${tableName}" ]
then
   if "${allowTextTable}" || "${allowContractionTable}" || "${allowLiblouisTable}"
   then
      defaultTableTypes=false
   else
      defaultTableTypes=true
   fi

   foundTextTable=0
   foundContractionTable=0
   foundLiblouisTable=0

   if "${allowTextTable}" || "${defaultTableTypes}"
   then
      ! testTable "${tableName}" "${textTablesDirectory}" "${textTableExtension}" || foundTextTable=1
   fi

   if "${allowContractionTable}" || "${defaultTableTypes}"
   then
      ! testTable "${tableName}" "${contractionTablesDirectory}" "${contractionTableExtension}" || foundContractionTable=1
   fi

   if "${allowLiblouisTable}"
   then
      tables=($(
         set -e
         cd "${liblouisTablesDirectory}"

         if [ "${tableName}" = "${tableName%.*}" ]
         then
            echo "${tableName}".*
         elif [ -f "${tableName}" ]
         then
            echo "${tableName}"
         fi
      ))

      foundLiblouisTable="${#tables[*]}"

      if [ "${foundLiblouisTable}" -eq 1 ]
      then
         liblouisTableName="louis:${tables[0]}"
      elif [ "${foundLiblouisTable}" -gt 1 ]
      then
         logWarning "ambiguous LibLouis table: ${tables[*]}"
      fi
   fi

   foundCount=$((foundTextTable + foundContractionTable + foundLiblouisTable))
   ((foundCount < 2)) || semanticError "ambiguous table name: ${tableName}"

   if ((foundTextTable))
   then
      brailleVariant="computer"
      literaryBraille="no"
   elif ((foundContractionTable))
   then
      brailleVariant="literary"
      literaryBraille="yes"
   elif ((foundLiblouisTable))
   then
      brailleVariant="literary"
      literaryBraille="yes"
      tableName="${liblouisTableName}"
   else
      semanticError "table not found: ${tableName}"
   fi

   "${programDirectory}/canute-parameter" "${brailleVariant}-braille-table" "${tableName}"
   "${programDirectory}/canute-parameter" "literary-braille" "${literaryBraille}"
else
   parameter="literary-braille"
   response="$("${programDirectory}/canute-parameter" "${parameter}")"

   case "${response}"
   in
       true) brailleVariant="literary";;
      false) brailleVariant="computer";;
      *) semanticError "unexpected response: ${parameter}=${response}";;
   esac

   parameter="${brailleVariant}-braille-table"
   tableName="$("${programDirectory}/canute-parameter" "${parameter}")"
   echo "${tableName} - ${brailleVariant} braille"
fi

exit 0
