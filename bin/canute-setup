#!/bin/bash

installTree="/brltty/current"
. "${installTree}/bin/brltty-prologue.sh"

requiredPackages=(
   gnome-terminal
   marco
   screen
)

addProgramOption A flag allActions "perform all of the actions"
addProgramOption p flag hostPackages "install the host packages"
addProgramOption e flag etcFiles "install the /etc/ files"
addProgramOption k flag apiKey "generate the BrlAPI access key"
addProgramOption l flag sharedLibraries "configure the shared libraries"
addProgramOption u flag udevReload "reload the Udev rules"
addProgramOption s flag systemdUnits "configure the Systemd units"
parseProgramArguments "${@}"
verifyActionFlags allActions hostPackages etcFiles apiKey sharedLibraries udevReload systemdUnits

[ "$(id -u)" -eq 0 ] || semanticError "not executing as root"
set -e

! "${hostPackages}" || apt --yes --quiet --quiet --quiet install -- "${requiredPackages[@]}"
! "${etcFiles}" || tar --extract --file "${installTree}/etc.tar" --directory "/"

! "${apiKey}" || {
   apiKeyFile="/etc/brlapi.key"
   "${installTree}/bin/brltty-genkey" -q -f "${apiKeyFile}"
   chmod u=rw,go=r "${apiKeyFile}"
}

! "${sharedLibraries}" || ldconfig
! "${udevReload}" || udevadm control --reload

! "${systemdUnits}" || {
   systemdUnit="brltty@canute.path"

   systemctl daemon-reload
   systemctl enable "${systemdUnit}"
   systemctl start "${systemdUnit}"
}

exit 0
