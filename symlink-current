#!/bin/bash
. "$(dirname "${0}")/prologue.sh"

addTestModeOption
addSourceTreeOption
addBuildTreeOption
parseProgramArguments "${@}"

verifySourceTree
verifyBuildTree

set -e
getInstallTree installTree
testDirectory "${installTree}" || semanticError "install tree not found: ${installTree}"

installSubdirectory="$(basename "${installTree}")"
installLocation="$(dirname "${installTree}")"
linkPath="${installLocation}/current"

if [ -L "${linkPath}" ]
then
   [ "$(readlink "${linkPath}")" != "${installSubdirectory}" ] || {
      logStep "link already correct: ${linkPath} -> ${installSubdirectory}"
      exit 0
   }

   executeHostCommand sudo rm -- "${linkPath}"
elif [ -e "${linkPath}" ]
then
   semanticError "not a symbolic link: ${linkPath}"
fi

executeHostCommand sudo ln --symbolic -- "${installSubdirectory}" "${linkPath}"
exit 0
